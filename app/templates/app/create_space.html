{% extends "base.html" %}
{% load static %}

{% block title %}Create Spaces{% endblock %}

{% block extra_css %}
<style>
    .preview-card {
        max-width: 400px;
        margin: 0 auto;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }
    .preview-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .preview-image {
        width: 200px;
        height: 200px;
        object-fit: cover;
        background-color: #f0f0f0;
        margin: 0 auto 1rem;
        display: block;
    }
    .preview-content {
        padding: 1.5rem;
        text-align: center;
    }
    .preview-header {
        font-size: 1.25rem;
        font-weight: 500;
        color: #333;
        margin-bottom: 0.5rem;
    }
    .preview-message {
        color: #666;
        margin-bottom: 1.5rem;
    }
    .preview-questions {
        text-align: left;
        margin-bottom: 1.5rem;
    }
    .preview-questions h3 {
        font-size: 1rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 0.5rem;
    }
    .preview-questions ul {
        list-style: none;
        padding: 0;
        margin: 0;
        color: #666;
    }
    .preview-questions li {
        margin-bottom: 0.25rem;
    }
    .send-button {
        background-color: #0066ff;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 0.75rem;
        width: 100%;
        font-size: 1rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }
    .send-button:hover {
        background-color: #0052cc;
    }
    .upgrade-text {
        color: #666;
        font-size: 0.875rem;
    }
    .form-section {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 2rem;
    }
    .question-row {
        background-color: #f8f9fa;
        border-radius: 4px;
        padding: 0.75rem;
        margin-bottom: 0.75rem;
        display: flex;
        gap: 0.5rem;
    }
    .remove-question {
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    .question-row:hover .remove-question {
        opacity: 1;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row g-4">
        <!-- Left Column: Live Preview -->
        <div class="col-lg-4">
            <div class="preview-card">
                <div class="card-header bg-success text-white">
                    Live preview - Testimonial page
                </div>
                <div class="preview-content">
                    <img id="preview-space-logo" src="https://via.placeholder.com/200x200.png?text=No+Image" alt="Space Logo" class="preview-image">
                    <h2 id="preview-header-title" class="preview-header">Header goes here...</h2>
                    <p id="preview-message" class="preview-message">Your custom message goes here...</p>
                    
                    <div class="preview-questions">
                        <h3>QUESTIONS</h3>
                        <ul id="preview-questions">
                            <li>â€¢ No questions added yet...</li>
                        </ul>
                    </div>

                    <button class="send-button">
                        <i class="bi bi-pencil"></i>
                        Send in text
                    </button>
                </div>
                <div class="card-footer text-muted text-center">
                    <small>ðŸ‘‰ Upgrade to Premium </small>
                </div>     
            </div>
        </div>

        <!-- Right Column: Form -->
        <div class="col-lg-8">
            <div class="form-section">
                <h2 class="h3 mb-4 text-center">Create a New Space</h2>
                <p class="text-muted text-center mb-5">After the Space is created, it will generate a dedicated page for collecting testimonials.</p>
                
                <form method="post" enctype="multipart/form-data" id="create-space-form" novalidate>
                    {% csrf_token %}

                    {% if form.non_field_errors %}
                        <ul class="errorlist">
                            {% for error in form.non_field_errors %}
                                <li class="text-danger">{{ error }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                    <div class="mb-4">
                        <label for="{{ form.spaces_name.id_for_label }}" class="form-label">Space Name <span class="text-danger">*</span></label>
                        {{ form.spaces_name }}
                        {% if form.spaces_name.errors %}
                        <ul class="errorlist">
                            {% for error in form.spaces_name.errors %}
                                <li class="text-danger">{{ error }}</li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </div>

                    <div class="mb-4">
                        <label for="{{ form.header_title.id_for_label }}" class="form-label">Header Title <span class="text-danger">*</span></label>
                        {{ form.header_title }}
                        {% if form.header_title.errors %}
                        <ul class="errorlist">
                            {% for error in form.header_title.errors %}
                                <li class="text-danger">{{ error }}</li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </div>

                    <div class="mb-4">
                        <label for="{{ form.message.id_for_label }}" class="form-label">Custom Message <span class="text-danger">*</span></label>
                        {{ form.message }}
                        {% if form.message.errors %}
                            <ul class="errorlist">
                                {% for error in form.message.errors %}
                                    <li class="text-danger">{{ error }}</li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    </div>

                    <div class="mb-4">
                        <label for="{{ form.spaces_logo.id_for_label }}" class="form-label">Space Logo <span class="text-danger">*</span></label>
                        {{ form.spaces_logo }}
                        {% if form.spaces_logo.errors %}
                            <ul class="errorlist">
                                {% for error in form.spaces_logo.errors %}
                                    <li class="text-danger">{{ error }}</li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                        <small class="form-text text-muted">
                            Recommended size: 200x200 pixels. Maximum file size: 5MB.
                        </small>
                    </div>

                    <div class="form-check form-switch mb-4">
                        {{ form.star_rating }}
                        <label class="form-check-label" for="{{ form.star_rating.id_for_label }}">Collect Star rating</label>
                        {% if form.star_rating.errors %}
                            <ul class="errorlist">
                                {% for error in form.star_rating.errors %}
                                    <li class="text-danger">{{ error }}</li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    </div>

                    <h3 class="h5 mb-3">Questions <span class="text-danger">*</span></h3>
                    <small class="text-muted">(Up to {{ max_questions }} Questions)</small>
                    <p id="question-limit-message" class="text-danger font-italic mt-2" style="display: none;">You can only add up to {{ max_questions }} questions.</p>

                    <div id="question-formset" class="mb-4">
                        {{ formset.management_form }}
                        <div id="forms-container">
                            {% for form in formset %}
                                <div class="question-row">
                                    {{ form.question_text }}
                                    <button type="button" class="btn btn-outline-danger btn-sm remove-question" title="Remove this question">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                    <button type="button" id="add-question" class="btn btn-outline-primary mb-4">
                        <i class="bi bi-plus-circle me-2"></i>Add Question
                    </button>

                    
                    <!-- Submit Button -->
                    <div class="d-flex justify-content-end">
                        <button type="submit" class="btn btn-primary mb-3">Create Space</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('create-space-form');
    const formsContainer = document.getElementById('forms-container');
    const addQuestionBtn = document.getElementById('add-question');
    const questionLimitMessage = document.getElementById('question-limit-message');
    const maxQuestions = {{ max_questions }};
    let formIndex = formsContainer.children.length;

    function updatePreview() {
        document.getElementById('preview-header-title').textContent = document.getElementById('id_header_title').value || 'Header goes here...';
        document.getElementById('preview-message').textContent = document.getElementById('id_message').value || 'Your custom message goes here...';

        const previewQuestions = document.getElementById('preview-questions');
        previewQuestions.innerHTML = '';
        const questionInputs = formsContainer.querySelectorAll('input[name$="-question_text"]');
        
        if (questionInputs.length === 0 || (questionInputs.length === 1 && !questionInputs[0].value)) {
            previewQuestions.innerHTML = '<li>â€¢ No questions added yet...</li>';
        } else {
            questionInputs.forEach((input) => {
                if (input.value) {
                    const li = document.createElement('li');
                    li.textContent = `â€¢ ${input.value}`;
                    previewQuestions.appendChild(li);
                }
            });
        }
    }

    function addQuestion() {
        if (formIndex < maxQuestions) {
            const newForm = formsContainer.children[0].cloneNode(true);
            const formRegex = RegExp(`questions-(\\d+)-`,'g');
            newForm.innerHTML = newForm.innerHTML.replace(formRegex, `questions-${formIndex}-`);
            newForm.querySelector('input').value = '';
            formsContainer.appendChild(newForm);
            formIndex++;
            document.getElementById('id_questions-TOTAL_FORMS').value = formIndex;
            updateQuestionLimit();
            updatePreview();
        }
    }

    function removeQuestion(event) {
        if (formsContainer.children.length > 1) {
            event.target.closest('.question-row').remove();
            formIndex--;
            document.getElementById('id_questions-TOTAL_FORMS').value = formIndex;
            updateQuestionLimit();
            updatePreview();
        }
    }

    function updateQuestionLimit() {
        addQuestionBtn.disabled = formIndex >= maxQuestions;
        questionLimitMessage.style.display = formIndex >= maxQuestions ? 'block' : 'none';
    }

    addQuestionBtn.addEventListener('click', addQuestion);
    formsContainer.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-question') || e.target.closest('.remove-question')) {
            removeQuestion(e);
        }
    });

    ['id_spaces_name', 'id_header_title', 'id_message'].forEach(id => {
        document.getElementById(id).addEventListener('input', updatePreview);
    });

    document.getElementById('id_spaces_logo').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('preview-space-logo').src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    });

    formsContainer.addEventListener('input', updatePreview);

    form.addEventListener('submit', function(event) {
        if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
        }
        form.classList.add('was-validated');
    }, false);

    updatePreview();
    updateQuestionLimit();
});
</script>
{% endblock %}