{% extends "base.html" %}
{% load static %}

{% block title %}Update Spaces{% endblock %}

{% block extra_css %}
<style>
   .preview-card {
    max-width: 400px;
    margin: 0 auto;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    position: sticky; /* Make it sticky */
    top: 0; /* Stick to the top of the screen */
    z-index: 100; /* Ensure it stays on top of other content */
    }

    .preview-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .preview-image {
        width: 200px;
        height: 200px;
        object-fit: cover;
        background-color: #f0f0f0;
        margin: 0 auto 1rem;
        display: block;
    }
    .preview-content {
        padding: 1.5rem;
        text-align: center;
    }
    .preview-header {
        font-size: 1.25rem;
        font-weight: 500;
        color: #333;
        margin-bottom: 0.5rem;
    }
    .preview-message {
        color: #666;
        margin-bottom: 1.5rem;
    }
    .preview-questions {
        text-align: left;
        margin-bottom: 1.5rem;
    }
    .preview-questions h3 {
        font-size: 1rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 0.5rem;
    }
    .preview-questions ul {
        list-style: none;
        padding: 0;
        margin: 0;
        color: #666;
    }
    .preview-questions li {
        margin-bottom: 0.25rem;
    }
    .send-button {
        background-color: #0066ff;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 0.75rem;
        width: 100%;
        font-size: 1rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }
    .send-button:hover {
        background-color: #0052cc;
    }
    .upgrade-text {
        color: #666;
        font-size: 0.875rem;
    }
    .form-section {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 2rem;
    }
    .question-row {
        background-color: #f8f9fa;
        border-radius: 4px;
        padding: 0.75rem;
        margin-bottom: 0.75rem;
        display: flex;
        gap: 0.5rem;
    }
    .remove-question {
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    .question-row:hover .remove-question {
        opacity: 1;
    }
</style>
{% endblock %}

{% block content %}


<div class="container mt-5" id="main-container">
    <div class="row g-4">
        <!-- Left Column: Live Preview -->
        <div class="col-lg-4">
            <div class="preview-card">
                <div class="card-header bg-success text-white">
                    Live preview - Testimonial page
                </div>
                <div class="preview-content">
                    <img id="preview-space-logo" 
                    src="{% if form.instance.spaces_logo %}{{ form.instance.spaces_logo.url }}{% else %}https://via.placeholder.com/200x200.png?text=No+Image{% endif %}" 
                    alt="Space Logo" 
                    class="preview-image">
                    
               
                                   <h2 id="preview-header-title" class="preview-header">{{ form.instance.header_title }}</h2>
                    <p id="preview-message" class="preview-message">{{ form.instance.message }}</p>
                    
                    <div class="preview-questions">
                        <h3>QUESTIONS</h3>
                        <ul id="preview-questions">
                            {% for question_form in formset %}
                                <li id="preview-question-{{ forloop.counter0 }}">{{ question_form.instance.question_text }}</li>
                            {% endfor %}
                        </ul>
                    </div>

                    <button class="send-button">
                        <i class="bi bi-pencil"></i>
                        Send in text
                    </button>
                </div>
                <div class="card-footer text-muted text-center">
                    <small>ðŸ‘‰ Upgrade to Premium </small>
                </div>     
            </div>
        </div>

        <!-- Right Column: Form -->
        <div class="col-lg-8">
            <div class="form-section">
                <h2 class="h3 mb-4 text-center">Update Space -  {{ space.spaces_name }}</h2>
                
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    {% if form.non_field_errors %}
                        <ul class="errorlist">
                            {% for error in form.non_field_errors %}
                                <li class="text-danger">{{ error }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                    <div class="card mb-4">
                        <div class="card-body">
                            <h4 class="card-title">Space Details</h4>
                            
                            <!-- Individual rendering for each form field -->
                            <div class="mb-3">
                                <label for="{{ form.spaces_name.id_for_label }}" class="form-label">{{ form.spaces_name.label }}</label>
                                {{ form.spaces_name }}
                                {% if form.spaces_name.errors %}
                                    <div class="text-danger">
                                        {% for error in form.spaces_name.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        
                            <div class="mb-3">
                                <label for="{{ form.header_title.id_for_label }}" class="form-label">{{ form.header_title.label }}</label>
                                {{ form.header_title }}
                                {% if form.header_title.errors %}
                                    <div class="text-danger">
                                        {% for error in form.header_title.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        
                            <div class="mb-3">
                                <label for="{{ form.message.id_for_label }}" class="form-label">{{ form.message.label }}</label>
                                {{ form.message }}
                                {% if form.message.errors %}
                                    <div class="text-danger">
                                        {% for error in form.message.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        
                            <div class="mb-3">
                                <label for="{{ form.spaces_logo.id_for_label }}" class="form-label">{{ form.spaces_logo.label }}</label>
                                
                                {{ form.spaces_logo }}
                                {% if form.spaces_logo.errors %}
                                    <div class="text-danger">
                                        {% for error in form.spaces_logo.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    Current Image is shown on the preview
                                </small>
                            </div>
                        
                            <div class="form-check form-switch mb-3">
                                <label for="{{ form.star_rating.id_for_label }}" class="form-label">{{ form.star_rating.label }}</label>
                                {{ form.star_rating }}
                                {% if form.star_rating.errors %}
                                    <div class="text-danger">
                                        {% for error in form.star_rating.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                    </div>
            
                    <div class="card mb-4">
                        <div class="card-body">
                            <h4 class="card-title">Questions</h4>

                            <!-- Display Non-Field Errors for the Formset -->
                                {% if formset.non_field_errors %}
                                <ul class="text-danger">
                                    {% for error in formset.non_field_errors %}
                                        <li>{{ error }}</li>
                                    {% endfor %}
                                </ul>
                            {% endif %}

            
                         

                            {{ formset.management_form }}
                            {% for question_form in formset %}
                                <div class="mb-3">
                                    {{ question_form.id }}
                                    <label for="{{ question_form.question_text.id_for_label }}" class="form-label">Question {{ forloop.counter }}</label>
                                    {{ question_form.question_text }}
                                    {% if question_form.errors %}
                                    <div class="text-danger">
                                        {% for error in question_form.question_text.errors %}
                                            <li>{{ error }}</li>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                    {% if not forloop.last %}
                                        <div class="form-check mt-2">
                                            {{ question_form.DELETE }}
                                            <label class="form-check-label" for="{{ question_form.DELETE.id_for_label }}">
                                                Delete this question
                                            </label>
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
            
                    <button type="submit" class="btn btn-primary">Update Space</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
        // Function to update the preview based on form values
        function updatePreview() {
            // Update the preview for the main fields
            document.getElementById('preview-header-title').textContent = document.getElementById('id_header_title').value || 'Header goes here...';
            document.getElementById('preview-message').textContent = document.getElementById('id_message').value || 'Your custom message goes here...';

            // Preview the questions
            const previewQuestions = document.getElementById('preview-questions');
            previewQuestions.innerHTML = ''; // Clear existing questions in preview

            // Collect all question text fields (even pre-populated ones)
            const questionInputs = document.querySelectorAll('[name$="-question_text"]');

            // Check if no questions are present or all are empty
            if (questionInputs.length === 0 || (questionInputs.length === 1 && !questionInputs[0].value)) {
                previewQuestions.innerHTML = '<li>â€¢ No questions added yet...</li>';
            } else {
                // Iterate through each question input and update the preview dynamically
                questionInputs.forEach((input) => {
                    if (input.value) {
                        const li = document.createElement('li');
                        li.textContent = `â€¢ ${input.value}`;
                        previewQuestions.appendChild(li);
                    }
                });
            }
        }

        // Call updatePreview on input events for the main fields
        document.getElementById('id_header_title').addEventListener('input', updatePreview);
        document.getElementById('id_message').addEventListener('input', updatePreview);

        // Dynamically update the preview for questions
        const questionInputs = document.querySelectorAll('[name$="-question_text"]');
        questionInputs.forEach((input) => {
            input.addEventListener('input', updatePreview);  // Update preview on input change
        });

        document.getElementById('id_spaces_logo').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('preview-space-logo').src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    });


        // Initialize preview with the existing values
        updatePreview(); 
    });
</script>
{% endblock %}

