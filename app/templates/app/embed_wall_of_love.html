{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Testimonials | Collect and Embed</title>
    <link href="{% static 'img/favicon.png' %}" rel="icon">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
            margin: 0;
            overflow-x: hidden;
        }
        .avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }
        .card:hover .avatar {
            transform: scale(1.1);
        }
        .star-rating {
            color: #ffc107;
        }
        .card {
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1rem;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }
        .testimonial-content {
            position: relative;
            overflow: hidden;
        }
        .show-more {
            color: #007bff;
            cursor: pointer;
        }
        .show-more:hover {
            color: #0056b3;
            text-decoration: underline;
        }
        .content-wrapper {
            flex: 1;
            padding: 20px; /* Adjust padding as needed */
        }
        .footer {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px 0;
            color: #0D6Dfd; /* Default color for text, adjust if needed */
        }
        .footer-logo {
            display: flex;
            align-items: center;
            font-size: 1.5rem;
            font-weight: bold;
        }
        .footer-logo img {
            max-height: 50px; /* Adjust to make the logo noticeable */
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-5">
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-4 mx-0" id="testimonials-container">
            <!-- Testimonial cards will be dynamically inserted here -->
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="testimonialModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="modalContent"></div>
            </div>
        </div>
    </div>

    {% if subscription != 'Pro' %}
    <footer class="footer">
        <div class="footer-logo">
            <img src="{% static 'img/logo.png' %}" alt="Company Logo">
            <span>Testimonials</span>
        </div>
    </footer>
    {% endif %}
   

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const testimonials = JSON.parse('{{ testimonials_json|escapejs }}');
        
        const colors = {
            A: "#8C6A5D", B: "#6A8C6D", C: "#5D8C8C", D: "#7A6A8C", E: "#8C7A5D", F: "#6D8C75",
            G: "#8C756A", H: "#6A7A8C", I: "#5D8C75", J: "#8C6D7A", K: "#6A8C8C", L: "#8C5D6A",
            M: "#7A8C6A", N: "#6A8C7A", O: "#8C7A75", P: "#756A8C", Q: "#5D7A8C", R: "#8C6A75",
            S: "#7A5D8C", T: "#6D8C8C", U: "#8C756D", V: "#8C8C5D", W: "#7A6A8C", X: "#6A8C7A",
            Y: "#8C5D7A", Z: "#756A8C"
        };

        const getInitials = (name) => {
            if (!name) return ""; 
            const words = name.trim().split(" ");
            return words.length > 1
                ? (words[0][0] + words[1][0]).toUpperCase()
                : name.slice(0, 2).toUpperCase();
        };
    
        const getRandomColorForInitial = (initial) => {
            const letter = initial.toUpperCase();
            return colors[letter] || "#CCCCCC";  
        };
    
        function createStarRating(rating) {
            return Array(5).fill().map((_, i) => `
                <i class="bi ${i < rating ? 'bi-star-fill' : 'bi-star'} star-rating"></i>
            `).join('');
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            const options = {
                month: 'long',
                day: 'numeric',
                year: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            };
            return date.toLocaleString('en-US', options);
        }

        function createTestimonialCard(testimonial, isModal = false) {
            const maxLength = 150;
            const needsShowMore = testimonial.testimonial__testimonial_text?.length > maxLength;
            
            const content = isModal 
                ? testimonial.testimonial__testimonial_text || 'No content available'
                : (needsShowMore ? (testimonial.testimonial__testimonial_text.slice(0, maxLength) + '...') : testimonial.testimonial__testimonial_text);
            
            const initials = getInitials(testimonial.testimonial__sender_name);
            const color = getRandomColorForInitial(initials[0]);
            const formattedDate = formatDate(testimonial.testimonial__created_at);

            return `
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="avatar me-3" style="background-color: ${color};">${initials}</div>
                            <div>
                                <h5 class="card-title mb-0">${testimonial.testimonial__sender_name}</h5>
                                ${
                                    testimonial.testimonial__star_rating !== null
                                        ? `<div>${createStarRating(testimonial.testimonial__star_rating)}</div>`
                                        : ''
                                }
                            </div>
                        </div>
                        <div class="testimonial-content ${needsShowMore && !isModal ? 'truncated' : ''}">
                            <p class="card-text">${content}</p>
                        </div>
                        ${!isModal && needsShowMore ? `<span class="show-more" data-id="${testimonial.testimonial__id}">Show more</span>` : ''}
                        <div class="text-muted mt-2 small">${formattedDate}</div>
                    </div>
                </div>
            `;
        }


        function renderTestimonials() {
            const container = document.getElementById('testimonials-container');
            testimonials.forEach(testimonial => {
                const col = document.createElement('div');
                col.className = 'col';
                col.innerHTML = createTestimonialCard(testimonial);
                container.appendChild(col);
            });
        }
    
        function setupEventListeners() {
            document.querySelectorAll('.show-more').forEach(button => {
                button.addEventListener('click', function() {
                    const testimonialId = this.getAttribute('data-id');
                    const testimonial = testimonials.find(t => t.testimonial__id === parseInt(testimonialId));
                    
                    if (testimonial) {
                        const modalContent = document.getElementById('modalContent');
                        modalContent.innerHTML = createTestimonialCard(testimonial, true);
                        const modal = new bootstrap.Modal(document.getElementById('testimonialModal'));
                        modal.show();
                    } else {
                        console.error('Testimonial not found for ID:', testimonialId);
                    }
                });
            });
        }
    
        document.addEventListener('DOMContentLoaded', function() {
            renderTestimonials();
            setupEventListeners();
        });
    </script>
</body>
</html>
